<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scheda Cliente</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="SB Training">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#fefaf5">

<style>
body{
  margin:0;
  font-family:'Inter',Arial,sans-serif;
  background:#fefaf5;
  color:#111;
}
.wrap{max-width:1000px;margin:0 auto;padding:20px}
.header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:2rem;color:#0b1220}
button{padding:8px 14px;border:2px solid #203070;border-radius:10px;font-weight:600;background:none;color:#203070;cursor:pointer}
button.primary{border-color:#800;background:#800;color:#fff}
.card{background:#fff;border:2px solid #ccc;border-radius:14px;padding:16px;margin-top:10px;box-shadow:0 2px 5px rgba(0,0,0,.05)}

.day{border:2px solid #bbb;border-radius:14px;padding:14px;margin:24px 0;background:#fff}
.day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.day h2{margin:0;font-size:1.5rem;color:#000}
.week-edit input{border:1px solid #999;border-radius:8px;padding:4px 8px;width:60px;text-align:center}

/* CARD ESERCIZIO */
.item{border:2px solid #d0d0d0;border-radius:12px;padding:10px;margin:16px 0;background:#fff}
.item-name{display:flex;align-items:center;gap:10px}
.item-name b{font-size:1.25rem;color:#111}
.tag{background:#eef1fa;padding:3px 8px;border-radius:999px;font-size:0.85rem;color:#334}

.lab-box{display:flex;gap:6px;justify-content:space-between;text-align:center;margin-top:10px}
.lab{flex:1;background:#7b0000;color:#fff;font-weight:700;border:1px solid #000;padding:4px 0;border-radius:6px}
.val{flex:1;text-align:center;margin-top:4px}
.val input{width:70%;max-width:100px;text-align:center;border:2px solid #090;border-radius:8px;padding:4px;font-size:1rem}

/* NOTE COACH (non modificabili) */
.note{background:#f4f4f4;border-radius:10px;padding:8px 10px;margin-top:10px;font-size:0.95rem}

/* NOTE CLIENTE (modificabili) */
.client-note{margin-top:8px}
.client-note-label{
  font-weight:600;
  font-size:0.9rem;
  color:#333;
  display:block;
  margin-bottom:4px;
}
.client-note textarea{
  width:100%;
  min-height:60px;
  border:1px solid #bbb;
  border-radius:8px;
  padding:6px;
  font-family:inherit;
  font-size:0.9rem;
  resize:vertical;
}

/* divisore tra i giorni */
.divider{height:6px;background:#d0e4ff;margin:40px 0;border-radius:3px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Scheda Cliente</h1>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="primary" id="btn-import">Importa scheda (.ptplan)</button>
      <button id="btn-print">Stampa / PDF</button>
      <button id="btn-reset">Reset modifiche</button>
    </div>
  </div>
  <div id="content" class="card">
    <p>Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>
  </div>
</div>

<script>
(function(){
  'use strict';

  function $(s){ return document.querySelector(s); }

  function esc(s){
    if (s === undefined || s === null) s = '';
    return String(s).replace(/[&<>]/g,function(m){
      return m === '&' ? '&amp;' : (m === '<' ? '&lt;' : '&gt;');
    });
  }

  /* ðŸ‘‰ NUOVO: genera un "ID esercizio" stabile dal nome */
  function getExerciseUID(name){
    if(!name) return '';
    return String(name)
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'_')   // tutto ciÃ² che non Ã¨ lettera/numero â†’ "_"
      .replace(/^_+|_+$/g,'');      // togli _ iniziali/finali
  }

  var plan = null;
  var LS_PLAN_KEY = 'client_saved_plan_v1';

  /* salvataggio Kg / Settimane */
  var LS_OVR_KEY = 'client_overrides_v19';
  var localOver = { kgByItemId:{}, weekByDayId:{} };

  function loadOverrides(){
    try{
      var raw = localStorage.getItem(LS_OVR_KEY);
      if(raw){
        var obj = JSON.parse(raw);
        if(obj && obj.kgByItemId && obj.weekByDayId){
          localOver = obj;
        }
      }
    }catch(e){}
  }

  function saveOverrides(){
    try{
      localStorage.setItem(LS_OVR_KEY, JSON.stringify(localOver));
    }catch(e){}
  }

  function techniqueLabel(item){
    var t = item.technique || item.tecnica || '';
    if(!t) return '';
    var pair =
      item.techPairName ||
      item.techniquePairName ||
      item.pairedExerciseName ||
      item.pairExerciseName ||
      item.pairedName || '';
    return pair ? (t + ' â€“ ' + pair) : t;
  }

  function hhmm(min,sec){
    if(!min && !sec) return '-';
    var mm = String(min || 0); if(mm.length<2) mm='0'+mm;
    var ss = String(sec || 0); if(ss.length<2) ss='0'+ss;
    return mm + ':' + ss;
  }

  function render(){
    var host = $('#content');
    if(!plan){
      host.innerHTML =
        '<p>Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. ' +
        'Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>';
      return;
    }

    var title = esc(plan.title || plan.client || 'Scheda');
    var html = '<h2 style="margin-top:0">' + title + '</h2>';

    var days = plan.days || [];
    for(var i=0;i<days.length;i++){
      var day = days[i];
      var dayId = day.id || ('d_' + i);

      var baseWeek = (day.week === undefined || day.week === null) ? 1 : day.week;
      var overWeek = localOver.weekByDayId[dayId];
      if(typeof overWeek === 'number' && !isNaN(overWeek) && overWeek > 0){
        baseWeek = overWeek;
      }

      var dayName = esc(day.name || ('Giorno ' + (i+1)));

      if(i>0) html += '<div class="divider"></div>';

      html += '<div class="day" data-day="'+dayId+'">' +
                '<div class="day-head">' +
                  '<h2>'+dayName+'</h2>' +
                  '<div class="week-edit">' +
                    '<span style="font-weight:700">SETTIMANA</span>' +
                    '<input type="number" min="1" step="1" value="'+baseWeek+'" data-week="'+dayId+'">' +
                  '</div>' +
                '</div>';

      var items = day.items || [];
      for(var j=0;j<items.length;j++){
        html += renderItem(items[j]);
      }

      html += '</div>';
    }

    host.innerHTML = html;
    wireInteractions();
  }

  function renderItem(it){
    var name = esc(it.exerciseName || it.name || 'Esercizio');

    /* ðŸ‘‰ ID stabile per l'esercizio basato sul nome */
    var nameForId = it.exerciseName || it.name || '';
    var exerciseUID = getExerciseUID(nameForId);
    if(!exerciseUID){
      // fallback: usa id/itemId se proprio manca il nome
      exerciseUID = (it.id || it.itemId || ('it_'+Math.random().toString(36).slice(2)));
    }
    var kgKey = exerciseUID;         // chiave logica per salvare i Kg
    var kgIdAttr = esc(kgKey);       // usato in data-kg

    var tech = techniqueLabel(it);
    var notes = esc(it.notes || it.note || '');
    var rest = hhmm(it.restMin, it.restSec);
    var reps = esc(it.reps || '');
    var sets = esc(it.sets || '');
    var serieRep = sets ? (sets + 'Ã—' + reps) : reps;

    var baseKg = (it.kg === undefined || it.kg === null) ? '' : it.kg;
    var overKg = localOver.kgByItemId[kgKey];
    if(overKg !== undefined && overKg !== null && overKg !== ''){
      baseKg = overKg;
    }

    var html = '';
    html += '<div class="item" data-item="'+kgIdAttr+'">';
    html +=   '<div class="item-name"><b>'+name+'</b>';
    if(tech){
      html += ' <span class="tag">'+tech+'</span>';
    }
    html +=   '</div>';

    html +=   '<div class="lab-box">' +
                '<div class="lab">Serie/Rep</div>' +
                '<div class="lab">Kg</div>' +
                '<div class="lab">Rec</div>' +
              '</div>';

    html +=   '<div class="lab-box">' +
                '<div class="val">'+serieRep+'</div>' +
                '<div class="val"><input data-kg="'+kgIdAttr+'" type="number" value="'+esc(baseKg)+'"></div>' +
                '<div class="val">'+rest+'</div>' +
              '</div>';

    if(notes){
      html += '<div class="note"><b>Note:</b> '+notes+'</div>';
    }

    html += '<div class="client-note">' +
              '<span class="client-note-label">Note cliente</span>' +
              '<textarea placeholder="Scrivi qui le tue note (sensazioni, difficoltÃ , ecc.)"></textarea>' +
            '</div>';

    html += '</div>';
    return html;
  }

  /* collega input settimana / Kg per salvare in localStorage */
  function wireInteractions(){
    var host = $('#content');

    // settimane
    var weekInputs = host.querySelectorAll('input[data-week]');
    for(var i=0;i<weekInputs.length;i++){
      (function(inp){
        var dayId = inp.getAttribute('data-week');
        inp.addEventListener('input', function(){
          var v = parseInt(inp.value,10);
          if(isNaN(v) || v < 1) v = 1;
          localOver.weekByDayId[dayId] = v;
          saveOverrides();
        });
      })(weekInputs[i]);
    }

    // Kg (ora salvati per exerciseUID)
    var kgInputs = host.querySelectorAll('input[data-kg]');
    for(var j=0;j<kgInputs.length;j++){
      (function(inp){
        var kgId = inp.getAttribute('data-kg'); // Ã¨ l'exerciseUID
        inp.addEventListener('input', function(){
          localOver.kgByItemId[kgId] = inp.value;
          saveOverrides();
        });
      })(kgInputs[j]);
    }
  }

  /* Import con compatibilitÃ  iPhone (input nel DOM) */
  function importPlan(){
    var inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.ptplan,.json,application/json';
    inp.style.display = 'none';
    document.body.appendChild(inp);

    inp.onchange = function(){
      var files = inp.files;
      if(!files || !files.length){
        document.body.removeChild(inp);
        return;
      }
      var f = files[0];

      var reader = new FileReader();
      reader.onload = function(e){
        try{
          var txt = e.target.result;
          var data = JSON.parse(txt);
          var p = data.plan || data;
          if(!p || !p.days || !p.days.length){
            alert('File non valido: struttura inesperata.');
            document.body.removeChild(inp);
            return;
          }
          plan = p;
          try{
            localStorage.setItem(LS_PLAN_KEY, JSON.stringify({plan:p}));
          }catch(err){}
          render();
        }catch(err){
          alert('Errore durante la lettura del file: ' + err.message);
        }
        document.body.removeChild(inp);
      };
      reader.readAsText(f);
    };

    inp.click();
  }

  function printPDF(){ window.print(); }

  function resetAll(){
    // ricarica la pagina (pulisce i valori a schermo ma lascia il piano salvato)
    location.reload();
  }

  function init(){
    loadOverrides();
    try{
      var raw = localStorage.getItem(LS_PLAN_KEY);
      if(raw){
        var data = JSON.parse(raw);
        var saved = data.plan || data;
        if(saved && saved.days && saved.days.length){
          plan = saved;
        }
      }
    }catch(e){}
    render();
  }

  document.addEventListener('DOMContentLoaded', function(){
    $('#btn-import').addEventListener('click', importPlan);
    $('#btn-print').addEventListener('click', printPDF);
    $('#btn-reset').addEventListener('click', resetAll);
    init();
  });

})();
</script>
</body>
</html>

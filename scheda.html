<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scheda Cliente</title>

<!-- PWA meta (lasciati invariati) -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Scheda Cliente">
<meta name="theme-color" content="#0c1a28">

<style>
:root{
  --bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
  --brand:#ff7a1a;--ok:#22c55e;
  --fs:clamp(12px,1.05vw,15px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:var(--fs) Inter,system-ui,Arial}
button,input{font:inherit}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
button.primary{background:var(--brand);color:#2d1600;border:none;font-weight:800}
.card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0));border:1px solid var(--border);border-radius:12px;padding:12px}
.day{border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0;background:#0b1220}
.day-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.day-title{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.day-title h2{margin:0;font-size:20px}
.week-edit{display:flex;align-items:center;gap:10px}
.week-edit .label{font-weight:700;color:var(--text);letter-spacing:.02em}
.week-edit input{width:72px;text-align:center;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:6px 8px}

/* CARD ESERCIZIO */
.item{border:1px dashed var(--border);border-radius:12px;padding:10px;margin:10px 0}
.item-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr; /* 3 colonne: 1) nome/icona 2) serie 3) ripetizioni, poi Kg/Recupero sotto */
  gap:10px;
  align-items:start;
}
.item-name{display:flex;align-items:center;gap:10px}
.item-name b{font-size:1.25em;line-height:1.1} /* NOME ESERCIZIO PIÙ GRANDE */
.ico-db{
  width:24px;height:24px;flex:0 0 24px;      /* ICONA MANUBRIO PIÙ GRANDE */
  display:inline-block;vertical-align:middle
}
.lab{font-size:.95em;color:var(--muted);margin-bottom:4px}
.val{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.val input[type="number"]{width:100%;min-width:0;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
.val input.kg{outline:2px solid var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.25)}
.tech{display:flex;gap:6px;align-items:center;margin-top:6px}
.tech .tag{background:#132033;border:1px solid #1f334f;color:#cde1ff;padding:4px 8px;border-radius:999px;font-size:.9em;white-space:nowrap}
.sep{height:1px;background:#1c2a3d;margin:12px 0}
.meta{font-size:.9em;color:var(--muted)}
.note{font-size:.95em;color:#d6d6d6}
.print-note{white-space:pre-wrap}
@media(max-width:820px){
  .item-grid{grid-template-columns:1fr 1fr 1fr}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1 style="margin:0">Scheda Cliente</h1>
    <div class="toolbar">
      <button id="btn-import" class="primary" type="button">Importa scheda (.ptplan)</button>
      <button id="btn-print" type="button">Stampa / PDF</button>
      <button id="btn-reset" type="button">Reset modifiche</button>
    </div>
  </div>

  <div id="content" class="card">
    <p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>
  </div>
</div>

<script>
(function(){
'use strict';

const $=s=>document.querySelector(s);
const esc=s=>String(s??'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));

// Icona manubrio accanto al nome esercizio
const SVG_DBELL = `
<svg class="ico-db" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
  <rect x="1.5" y="6" width="4" height="12" rx="1.5" fill="#94a3b8"/>
  <rect x="18.5" y="6" width="4" height="12" rx="1.5" fill="#94a3b8"/>
  <rect x="6" y="10.5" width="12" height="3" rx="1.5" fill="#e5e7eb"/>
</svg>`;

let plan=null;

/* ➊ Persistenza locale */
const LS_OVR_KEY='client_overrides_v19';      // Kg/Settimana (già esistente)
const LS_PLAN_KEY='client_saved_plan_v1';     // NUOVO: ultima scheda caricata

let localOver=null;
function loadOverrides(){
  try{ localOver=JSON.parse(localStorage.getItem(LS_OVR_KEY))||{weekByDayId:{},kgByItemId:{}}; }
  catch{ localOver={weekByDayId:{},kgByItemId:{}}; }
}
function saveOverrides(){ localStorage.setItem(LS_OVR_KEY, JSON.stringify(localOver)); }
loadOverrides();

function savePlan(p){ try{ localStorage.setItem(LS_PLAN_KEY, JSON.stringify({plan:p})); }catch{} }
function loadSavedPlan(){
  try{
    const raw = localStorage.getItem(LS_PLAN_KEY);
    if(!raw) return null;
    const data = JSON.parse(raw);
    return data.plan || data;
  }catch{ return null; }
}

function findPairedExerciseName(item){
  let pairName = item.techPairName || item.techniquePairName || item.pairedExerciseName || item.pairExerciseName || item.tech_exercise || '';
  let pairId   = item.techPairId   || item.techniquePairId   || item.pairedExerciseId   || item.pairExerciseId   || item.tech_ref       || '';
  if(!pairName && pairId){
    if(plan && Array.isArray(plan.exercises)){
      const e = plan.exercises.find(x=>x.id===pairId);
      if(e) pairName = e.name || '';
    }
    if(!pairName && plan && Array.isArray(plan.days)){
      for(const d of plan.days){
        const hit = (d.items||[]).find(x=>x.exerciseId===pairId);
        if(hit){ pairName = hit.exerciseName || ''; break; }
      }
    }
  }
  if(!pairName && item.pairedName) pairName=item.pairedName;
  return pairName;
}

function techniqueLabel(item){
  const t = item.technique || item.tecnica || '';
  if(!t) return '';
  const pair = findPairedExerciseName(item);
  return pair ? `${t} → ${pair}` : t;
}

function hhmm(min,sec){
  if(!min && !sec) return '-';
  const mm = String(min||0).padStart(2,'0');
  const ss = String(sec||0).padStart(2,'0');
  return `${mm}:${ss}`;
}

function render(){
  const host = $('#content');
  if(!plan){ host.innerHTML = `<p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>`; return; }

  const title = esc(plan.title || plan.client || 'Scheda');
  let html = `<h2 style="margin:0 0 8px">${title}</h2>`;

  (plan.days||[]).forEach(day=>{
    const dayId = day.id || day.dayId || ('d_'+Math.random().toString(36).slice(2));
    const weekNum = localOver.weekByDayId[dayId] ?? day.week ?? 1;
    const dayName = esc(day.name || '');
    html += `
    <div class="day" data-day="${dayId}">
      <div class="day-head">
        <div class="day-title">
          <h2>${dayName}</h2>
        </div>
        <div class="week-edit">
          <span class="label">SETTIMANA</span>
          <input type="number" min="1" step="1" value="${weekNum}" data-week="${dayId}">
        </div>
      </div>
      ${ (day.items||[]).map((it)=>renderItem(dayId,it)).join('<div class="sep"></div>') }
    </div>`;
  });

  host.innerHTML = html;

  // wiring settimane / kg
  (plan.days||[]).forEach(day=>{
    const dayId = day.id || day.dayId;
    const wkInp = host.querySelector(`input[data-week="${CSS.escape(dayId)}"]`);
    if(wkInp){
      wkInp.addEventListener('input', ()=>{
        let v = parseInt(wkInp.value,10);
        if(isNaN(v)||v<1) v = 1;
        localOver.weekByDayId[dayId]=v; saveOverrides();
      });
    }
    (day.items||[]).forEach(it=>{
      const kgId = it.id || it.itemId;
      const inp = host.querySelector(`input[data-kg="${CSS.escape(kgId)}"]`);
      if(inp){
        const initial = localOver.kgByItemId[kgId];
        if(initial!=null) inp.value = initial;
        inp.addEventListener('input', ()=>{
          localOver.kgByItemId[kgId] = inp.value;
          saveOverrides();
        });
      }
    });
  });
}

function renderItem(dayId, it){
  const name = esc(it.exerciseName || it.name || 'Esercizio');
  const kgId = esc(it.id || it.itemId || ('it_'+Math.random().toString(36).slice(2)));
  const tech = techniqueLabel(it);
  const notes = esc(it.notes || it.note || '');
  const rest = hhmm(it.restMin, it.restSec);

  return `
  <div class="item" data-item="${kgId}">
    <div class="item-grid">

      <!-- Esercizio (label) + Nome con icona -->
      <div>
        <div class="lab">Esercizio</div>
        <div class="item-name">
          ${SVG_DBELL}
          <b>${name}</b>
        </div>
        ${tech? `<div class="tech"><span class="tag">${esc(tech)}</span></div>`:''}
      </div>

      <!-- Serie -->
      <div>
        <div class="lab">Serie</div>
        <div class="val"><span>${esc(it.sets ?? '')}</span></div>
      </div>

      <!-- Ripetizioni -->
      <div>
        <div class="lab">Ripetizioni</div>
        <div class="val"><span>${esc(it.reps ?? '')}</span></div>
      </div>

      <!-- Kg -->
      <div>
        <div class="lab">Kg</div>
        <div class="val"><input class="kg" data-kg="${kgId}" type="number" min="0" step="0.5" value="${esc(it.kg ?? '')}"></div>
      </div>

      <!-- Recupero -->
      <div>
        <div class="lab">Recupero</div>
        <div class="val"><span>${rest}</span></div>
      </div>

      <!-- NOTE -->
      ${notes ? `
      <div class="note" style="grid-column:1/-1;margin-top:4px">
        <span class="lab" style="display:block;margin:0 0 2px">Note</span>
        <span class="print-note">${notes}</span>
      </div>` : ''}

    </div>
  </div>`;
}

/* Importa e SALVA la scheda */
function importPlan(){
  const inp = Object.assign(document.createElement('input'), {type:'file', accept:'.ptplan,.json,application/json'});
  inp.onchange = async ()=>{
    const f = inp.files?.[0]; if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      const p = data.plan || data;
      if(!p || !Array.isArray(p.days)) throw new Error('File non valido: mancano i giorni.');
      plan = p;
      savePlan(p);   // <— SALVA la scheda per riapertura automatica
      render();
      alert('Scheda importata.');
    }catch(e){
      alert('Import fallito: '+e.message);
    }
  };
  inp.click();
}

function printPDF(){
  if(!plan) return alert('Importa prima una scheda.');
  window.print();
}

function resetLocal(){
  if(!plan) return alert('Importa prima una scheda.');
  if(!confirm('Vuoi cancellare i Kg modificati e i numeri di Settimana salvati su questo dispositivo?')) return;
  localOver = {weekByDayId:{}, kgByItemId:{}};
  saveOverrides();
  render();
}

/* Avvio: se esiste una scheda salvata, caricala automaticamente */
(function init(){
  const saved = loadSavedPlan();
  if(saved && Array.isArray(saved.days)){
    plan = saved;
    render();
  }else{
    render(); // mostra messaggio “Importa il file…”
  }
})();

$('#btn-import').addEventListener('click', importPlan);
$('#btn-print').addEventListener('click', printPDF);
$('#btn-reset').addEventListener('click', resetLocal);

})();
</script>
</body>
</html>

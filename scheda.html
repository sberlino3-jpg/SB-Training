<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scheda Cliente</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="SB Training">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#faf7f2">

<style>
:root{
  --bg:#faf7f2;
  --card:#ffffff;
  --text:#0f1a2d;
  --muted:#6c7480;
  --border:#e4e4e4;
  --accent:#4864aa;
  --brand:#a01818;
  --ok:#2ea44f;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Inter',system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
button,input{font:inherit}
.wrap{max-width:900px;margin:0 auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap}
button{
  border:1.5px solid var(--accent);
  background:transparent;
  color:var(--accent);
  border-radius:8px;
  padding:8px 14px;
  cursor:pointer;
  transition:all .2s ease;
}
button:hover{background:var(--accent);color:#fff}
button.primary{border-color:var(--brand);color:var(--brand);}
button.primary:hover{background:var(--brand);color:#fff}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.05);padding:16px;}
.day{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin:20px 0;box-shadow:0 2px 4px rgba(0,0,0,0.04);}
.day-head{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px}
.day-title h2{margin:0;font-size:1.2rem;color:#000;}
.week-edit{display:flex;align-items:center;gap:8px}
.week-edit .label{font-weight:600;color:var(--text)}
.week-edit input{
  width:70px;text-align:center;
  border:1px solid var(--border);
  border-radius:6px;
  padding:6px 8px;
  background:#fff;
  color:var(--text);
}

.item{border:1px solid var(--border);border-radius:10px;padding:14px;margin:14px 0;background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,0.05);}
.item-name{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.item-name b{font-size:1.1rem;color:var(--text);}
.ico-db{width:22px;height:22px;flex:0 0 22px}
.tag{
  background:#f0f2f5;
  color:var(--accent);
  border-radius:999px;
  font-size:0.85rem;
  padding:3px 8px;
}
.lab{
  font-size:.9rem;
  font-weight:600;
  color:#fff;
  background:var(--brand);
  border:1px solid #000;
  border-radius:3px;
  padding:4px 8px;
  text-align:center;
  width:90px;
  overflow:hidden;         /* ✅ Evita che il testo esca dai bordi */
  white-space:nowrap;
  text-overflow:ellipsis;
}
.val{
  font-size:1rem;
  font-weight:600;
  color:var(--text);
  text-align:center;
}
.val input[type="number"]{
  width:90px;
  background:#fff;
  color:var(--text);
  border:2px solid var(--border);
  border-radius:6px;
  padding:6px 0;
  text-align:center;
}
.val input.kg{border-color:var(--ok)}
.val input[type="number"]:focus{border-color:var(--brand);outline:none}
.sep{height:1px;background:#ececec;margin:12px 0}
.note{
  background:#f9f9f9;
  border-radius:8px;
  padding:8px 10px;
  font-size:0.95rem;
  color:#2b2b2b;
  font-weight:600;
}
.meta{font-size:0.9rem;color:var(--muted);}
.tech{margin-top:6px}

.grid{
  display:grid;
  grid-template-columns: repeat(3, 90px);
  justify-content:center;
  align-items:start;
  gap:16px;
  margin-top:8px;
}

@media(max-width:600px){
  .item{padding:12px}
  .day{padding:12px}
  .day-title h2{font-size:1.05rem}
  .grid{gap:10px}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <h1>Scheda Cliente</h1>
    <div class="toolbar">
      <button id="btn-import" class="primary" type="button">Importa scheda (.ptplan)</button>
      <button id="btn-print" type="button">Stampa / PDF</button>
      <button id="btn-reset" type="button">Reset modifiche</button>
    </div>
  </div>

  <div id="content" class="card">
    <p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>
  </div>
</div>

<script>
(function(){
'use strict';
const $=s=>document.querySelector(s);
const esc=s=>String(s??'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
const SVG_DBELL=`<svg class="ico-db" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="1.5" y="6" width="4" height="12" rx="1" fill="#a01818" stroke="#000" stroke-width="0.5"/><rect x="18.5" y="6" width="4" height="12" rx="1" fill="#a01818" stroke="#000" stroke-width="0.5"/><rect x="6" y="10.5" width="12" height="3" rx="1" fill="#6b0000" stroke="#000" stroke-width="0.5"/></svg>`;
let plan=null;
const LS_OVR_KEY='client_overrides_v19';
const LS_PLAN_KEY='client_saved_plan_v1';
let localOver={weekByDayId:{},kgByItemId:{}};
try{localOver=JSON.parse(localStorage.getItem(LS_OVR_KEY))||localOver;}catch{}

function saveOverrides(){localStorage.setItem(LS_OVR_KEY,JSON.stringify(localOver));}

function readEquipmentFromItem(it){
  const keys=['equipment','attrezzo','tool','machine','equipmentType','equip','device','attrezzatura'];
  for(const k of keys){if(it&&it[k])return String(it[k]);}return'';
}
function readEquipmentFromLibrary(exerciseId){
  if(!exerciseId||!plan||!Array.isArray(plan.exercises))return'';
  const lib=plan.exercises.find(e=>e.id===exerciseId||e.exerciseId===exerciseId);
  if(!lib)return'';
  const keys=['equipment','attrezzo','tool','machine','equipmentType','equip','device','attrezzatura'];
  for(const k of keys){if(lib[k])return String(lib[k]);}
  if(lib.meta&&(lib.meta.equipment||lib.meta.attrezzo))return String(lib.meta.equipment||lib.meta.attrezzo);
  return'';
}
function getEquipment(it){return readEquipmentFromItem(it)||readEquipmentFromLibrary(it.exerciseId||it.id)||'';}
function techniqueLabel(item){const t=item.technique||item.tecnica||'';if(!t)return'';const p=item.techPairName||item.pairedExerciseName||'';return p?`${t} → ${p}`:t;}
function hhmm(m,s){if(!m&&!s)return'-';const mm=String(m||0).padStart(2,'0');const ss=String(s||0).padStart(2,'0');return`${mm}:${ss}`;}

function render(){
  const host=$('#content');
  if(!plan){host.innerHTML=`<p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda.</p>`;return;}
  const title=esc(plan.title||plan.client||'Scheda');
  let html=`<h2 style="margin-bottom:10px;font-weight:600">${title}</h2>`;
  (plan.days||[]).forEach(day=>{
    const dayId=day.id||day.dayId||('d_'+Math.random().toString(36).slice(2));
    const weekNum=localOver.weekByDayId[dayId]??day.week??1;
    const dayName=esc(day.name||'');
    html+=`
    <div class="day" data-day="${dayId}">
      <div class="day-head">
        <div class="day-title"><h2>${dayName}</h2></div>
        <div class="week-edit">
          <span class="label">SETTIMANA</span>
          <input type="number" min="1" step="1" value="${weekNum}" data-week="${dayId}">
        </div>
      </div>
      ${(day.items||[]).map(it=>renderItem(it)).join('<div class="sep"></div>')}
    </div>`;
  });
  host.innerHTML=html;
  (plan.days||[]).forEach(day=>{
    const dayId=day.id||day.dayId;
    const wkInp=host.querySelector(`input[data-week="${CSS.escape(dayId)}"]`);
    if(wkInp)wkInp.addEventListener('input',()=>{
      let v=parseInt(wkInp.value,10);if(isNaN(v)||v<1)v=1;
      localOver.weekByDayId[dayId]=v;saveOverrides();
    });
    (day.items||[]).forEach(it=>{
      const kgId=it.id||it.itemId;
      const inp=host.querySelector(`input[data-kg="${CSS.escape(kgId)}"]`);
      if(inp){
        const initial=localOver.kgByItemId[kgId];
        if(initial!=null)inp.value=initial;
        inp.addEventListener('input',()=>{
          localOver.kgByItemId[kgId]=inp.value;saveOverrides();
        });
      }
    });
  });
}
function renderItem(it){
  const name=esc(it.exerciseName||it.name||'Esercizio');
  const kgId=esc(it.id||it.itemId||('it_'+Math.random().toString(36).slice(2)));
  const tech=techniqueLabel(it);
  const notes=esc(it.notes||it.note||'');
  const rest=hhmm(it.restMin,it.restSec);
  const eq=getEquipment(it);
  const series=it.sets??'';
  const reps=it.reps??'';
  const combo=series&&reps?`${series}×${reps}`:(series||reps||'');

  return`
  <div class="item">
    <div class="item-name">${SVG_DBELL}<b>${name}</b>${eq?`<span class="tag">${esc(eq)}</span>`:''}</div>
    ${tech?`<div class="tech"><span class="tag">${esc(tech)}</span></div>`:''}
    <div class="sep"></div>
    <div class="grid">
      <div><div class="lab">Serie/Rep</div><div class="val">${combo}</div></div>
      <div><div class="lab">Kg</div><div class="val"><input class="kg" data-kg="${kgId}" type="number" step="0.5" value="${esc(it.kg??'')}"></div></div>
      <div><div class="lab">Rec</div><div class="val">${rest}</div></div>
    </div>
    ${notes?`<div class="note" style="margin-top:10px;"><b>Note:</b> ${notes}</div>`:''}
  </div>`;
}
function importPlan(){
  const inp=Object.assign(document.createElement('input'),{type:'file',accept:'.ptplan,.json,application/json'});
  inp.onchange=async()=>{
    const f=inp.files?.[0];if(!f)return;
    try{
      const txt=await f.text();
      const data=JSON.parse(txt);
      const p=data.plan||data;
      if(!p||!Array.isArray(p.days))throw new Error('File non valido.');
      plan=p;localStorage.setItem(LS_PLAN_KEY,JSON.stringify({plan:p}));
      render();alert('Scheda importata.');
    }catch(e){alert('Errore: '+e.message);}
  };
  inp.click();
}
function printPDF(){if(!plan)return alert('Importa prima una scheda.');window.print();}
function resetLocal(){
  if(!plan)return alert('Importa prima una scheda.');
  if(!confirm('Vuoi cancellare i Kg modificati e i numeri di Settimana?'))return;
  localOver={weekByDayId:{},kgByItemId:{}};saveOverrides();render();
}
(function init(){
  try{
    const raw=localStorage.getItem(LS_PLAN_KEY);
    if(raw){const data=JSON.parse(raw);const saved=data.plan||data;
      if(saved&&Array.isArray(saved.days))plan=saved;
    }
  }catch{}
  render();
})();
$('#btn-import').addEventListener('click',importPlan);
$('#btn-print').addEventListener('click',printPDF);
$('#btn-reset').addEventListener('click',resetLocal);
})();
</script>
<script src="sw-register.js" defer></script>
</body>
</html>
